<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Proj-Filtering</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

  <link rel='stylesheet prefetch' href='https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css'>

      <link rel="stylesheet" href="css/style.css">

  
</head>

<body>
  <div class="container">
  
  <div class="demo-flex-spacer"></div>

  <div class="webflow-style-input">
    <input id="input" type="text" placeholder="여기를 눌러 문장 입력"></input>
    <button onclick="exec()"><i class="icon ion-android-arrow-forward"></i></button>
  </div>

  <div class="demo-flex-spacer"></div>
  <h1 class="demo">Proj-Filtering</h1>
  <a class="demo" href="https://github.com/ttakkku/Filtering" title="Github Repo">Github Repo (private)</a>

</div>

<script>
  /**
 * @name FilteringAPI
 * @description 이 API는 웹 전용 REST API입니다
 */

'use strict' // 엄격모드

/** Loging Module */
const markup = require('chalk')

/** Dialogflow Module */
process.env.GOOGLE_APPLICATION_CREDENTIALS = './../lib/BadWordsFilter-e34ed9d4dd5b.json'
const dialogflowId = 'badwordsfilter-esqgxe'
const dialogflow = require('dialogflow')

/** Nano ID Module */
const nanoid = require('nanoid')

/** Hangul Module */
const hangul = require('hangul-js')

/** English Module */
const isEnglish = require('is-alphabetical')

/** Dialogflow Client */
const dialogflowClient = new dialogflow.SessionsClient()

/** Bad Words DataBase */
const DB = require('../../../../public/BadWords.json')

/** Memory */
let temp = {}

function exec () {
  document.getElementById('input').disable = true

  /** @type {String} */
  let query = document.getElementById('input').value
  let queryArr = query.split(' ')

  proc(query, (result) => {
    if (result) {
      document.getElementsByClassName('container')[0].style.backgroundColor = '#df6363'
      document.getElementById('input').value = ''
      setTimeout(() => {
        document.getElementsByClassName('container')[0].style.backgroundColor = '#252736'
      }, 1000)
    } else {
      document.getElementsByClassName('container')[0].style.backgroundColor = '#59FF9E'
      document.getElementById('input').value = ''
      setTimeout(() => {
        document.getElementsByClassName('container')[0].style.backgroundColor = '#252736'
      }, 1000)
    }
  })
  document.getElementById('input').disable = false
}

/* --------------------- */
/**
 * 욕설 체크
 * @param {String} query 욕설인지 체크할 문자열
 * @param {function(boolean)} cb 욕설 여/부 콜백
 */
function check (query, cb) {
  if (query.length > 0) {
    let dialogflowPath = dialogflowClient.sessionPath(dialogflowId, nanoid())

    let dialogflowRequest = {
      session: dialogflowPath,
      queryInput: {
        text: {
          text: query,
          languageCode: 'ko-KR'
        }
      }
    }

    dialogflowClient.detectIntent(dialogflowRequest).then((dialogflowResponse) => {
      let dialogflowResponseText = dialogflowResponse[0].queryResult.fulfillmentText

      
      if (dialogflowResponseText.startsWith('badword: ')) {
        if (eval(dialogflowResponseText.split(' ')[1]) === true) {
          cb(true)
        } else {
          cb(false)
        }
      }
    })
  }
}

function proc (query, cb) {
  let isHangul = false
  query.split('').forEach((v, i) => {
    if (hangul.isHangul(v)) {
      isHangul = true
    }
  })
  if (isHangul) {
    check(query, (first) => {
      if (first) {
        cb(true)
      } else {
        let onlyKorean = ''
        query.split('').forEach((v, i) => {
          if (hangul.isHangul(v)) {
            onlyKorean += v
          }
        })
        check(onlyKorean, (second) => {
          if (second) {
            cb(true)
          } else {
            let hangulArr = hangul.disassemble(onlyKorean)
            let toEng = ''
            hangulArr.forEach((v, i) => {
              if (DB.hanYongKey.koreans.includes(v)) {
                toEng += DB.hanYongKey.englishs[DB.hanYongKey.koreans.indexOf(v)]
              }
            })
            check(toEng, (third) => {
              if (third) {
                cb(true)
              } else {
                cb(false)
              }
            })
          }
        })
      }
    })
  } else {
    check(query, (first) => {
      if (first) {
        cb(true)
      } else {
        console.log(markup.gray('---------EN-P2'))
        let onlyEnglish = ''
        query.split('').forEach((v) => {
          if (isEnglish(v)) {
            onlyEnglish += v
          }
        })
        check(onlyEnglish, (second) => {
          if (second) {
            cb(true)
          } else {
            let toKor = ''
            onlyEnglish.split('').forEach((v) => {
              if (DB.hanYongKey.englishs.includes(v)) {
                toKor +=  DB.hanYongKey.koreans[DB.hanYongKey.englishs.indexOf(v)]
              }
            })
            toKor = hangul.assemble(toKor)
            check(toKor, (third) => {
              if (third) {
                cb(true)
              } else {
                cb(false)
              }
            })
          }
        })
      }
    })
  }
}

</script>

</body>
</html>
